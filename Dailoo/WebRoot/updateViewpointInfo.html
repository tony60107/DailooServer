<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>更新景點資訊</title>
    <!-- 最新編譯和最佳化的 CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <!-- 選擇性佈景主題 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- 最新編譯和最佳化的 JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/addviewpoint.css">
    <style>
        .manage-links div {
            margin-right: 50px;
            margin-top: 30px;
            font-size: 18px;
        }
    </style>
</head>
<body>
<div class="w">
    <div class="main-title" style="margin-top: 20px; text-align: center; font-size: 35px; line-height: 35px;">更新景點資訊</div>

    <div id="links" class="manage-links clearfix"  style="margin-top: -76px;"></div>

    <div class="manage-links clearfix">
        <div class="fl"><a id="editAudio" href="#">編輯音檔圖片</a></div>
        <div class="fl"><a id="preview" href="">預覽景點</a></div>
    </div>

    <form id="mainForm" class="main-form" role="form" action="/ViewpointServlet?method=updateViewpoint" method="post"
          enctype="multipart/form-data">
        <div class="fl" style="font-size: 18px; margin-top: 30px; margin-right: 25px;">景點所在地區</div>
        <div class="area form-group clearfix">
            <input type="text" name="country" class="fl form-control" value="台灣" style="display: none">
            <input type="text" name="village" class="fl form-control" value="" style="display: none">
            <div id="twzipcode" style="width: 500px;">
                <div id="city" data-role="county" data-name="city" data-style="form-control area"
                     class="fl"></div>
                <div id="town" data-role="district" data-name="town" data-style="form-control area"
                     class="fl"></div>
                <div data-role="zipcode" data-name="zipcode" data-value="" data-style="form-control area"
                     style="display: none"></div>
            </div>
        </div>

        <div id="regionGroup" class="clearfix" style="margin-top: 50px; margin-bottom: 50px;">
            <div class="form-group">
                <label>主題地區</label><span onclick="addRegion();" style="margin-left: 30px; color: orange; cursor: pointer;">增加對應的主題</span>
                <select id="regionSelect0" type="text" name="regionId" class="form-control">
                    <option selected disabled hidden style='display: none' value=''>切換以選擇其他景點主題</option>
                </select>
                <label>景點主題</label>
                <select id="themeSelect0" name="themeId" class="village fl form-control">
                </select>
            </div>
        </div>

        <div class="form-group" style="display: none">
            <label>景點ID</label>
            <input id="viewpointId" type="text" name="id" class="form-control" placeholder="輸入景點ID" value="">
        </div>
        <div class="form-group">
            <label>景點名稱</label>
            <input id="name" type="text" name="name" class="form-control" placeholder="輸入景點名稱" value="">
        </div>
        <div class="form-group">
            <label>副標題</label>
            <input id="subtitle" type="text" name="subtitle" class="form-control" placeholder="輸入副標題" value="">
        </div>

        <div class="form-group">
            <label>講者</label>
            <select id="speaker_list" name="speakerId" class="fl form-control"></select>
        </div>


        <div class="form-group">
            <label>景點地址</label>
            <input id="address" type="text" name="address" class="form-control" placeholder="輸入景點地址" value="">
        </div>
        <div class="form-group fl" style="width: 280px; margin-right: 30px;">
            <label>緯度(可不填，由系統自動建立)</label>
            <input id="lat" type="text" name="latitude" class="form-control" placeholder="輸入緯度" value="">
        </div>
        <div class="form-group fl" style="width: 280px;">
            <label>經度(可不填，由系統自動建立)</label>
            <input id="lng" type="text" name="longitude" class="form-control" placeholder="輸入經度" value="">
        </div>
        <div class="form-group fl">
            <label>經緯度優先</label>
            <input id="latLngPri" type="checkbox" name="latLngPri" class="form-control" value="1">
        </div>
        <div id="map" style="width: 600px; height: 300px;"></div>
        <div class="form-group">
            <label>景點介紹</label>
            <textarea id="intro" type="text" name="intro" class="form-control" placeholder="輸入景點介紹" onpropertychange="this.style.height=this.scrollHeight+'px';"  oninput="this.style.height=this.scrollHeight+'px';" style="width: 100%; height:180px;overflow:hidden;"></textarea>
        </div>
        <div class="form-group">
            <label>景點代表圖</label>
            <input type="file" name="file1" class="form-control">
            <img id="behalfPhoto" src="#" style="width: 70px; height: 70px;"/>
        </div>
        <div class="form-group">
            <label>景點音檔</label>
            <input type="file" name="file" class="form-control">
            <div>
                ※目前支援mp3, aac, m4a, wav, 3gp/3gpp音檔格式<br/>
                若您不確定自己的音檔格式或需要轉換格式，<br/>
                可參考這裡的說明
            </div>
        </div>

        <input type="button" class="btn btn-default" value="更新" onClick="checkForm();">
    </form>

</div>
</body>
</html>
<script type="text/javascript" src="js/base.js"></script>
<script type="text/javascript" src="js/jquery.twzipcode.min.js"></script>
<script>
    var viewpointId = location.href.split("id=")[1];
    $$("viewpointId").value = viewpointId;
    var vp;
    var regions; //伺服器的地區資料
    var regionNum = 1;//現在到第幾個region編號

    getAllSpeakers();

    //取得現在所有的講者
    function getAllSpeakers() {
        $.ajax({
            url: "/SpeakerServlet", context: document.body,
            type: "POST",
            data: {
                "method": "findAllSpeakers"
            },
            success: function (speakers) {
                var speakers = eval("(" + speakers + ")");
                var speakerList = document.getElementById("speaker_list");
                for (var i = 0; i < speakers.length; i++) {
                    var dom = '<option value="' + speakers[i].id + '">' + (speakers[i].name == '' ? '未設定該講者姓名' : speakers[i].name) + '</option>';
                    speakerList.innerHTML = speakerList.innerHTML + dom;
                }
                $$("speaker_list").value = vp.speaker.id;
            },
            error: function(){
                setTimeout(function(){getAllSpeakers();}, 1000);
            }
        });

    }

    //取得該景點資訊
    $.ajax({
        url: "/ViewpointServlet", context: document.body,
        type: "POST",
        data: {
            "method": "getViewpointInfo",
            "id": viewpointId,
        },
        success: function (data) {
            vp = eval("(" + data + ")");
            console.dir(vp);
            initDataFromServer(vp)
        },
    });

    //初始化表單內容
    function initDataFromServer(vp){
        $$("name").value = vp.name;
        $$("subtitle").value = vp.subtitle;
        $$("address").value = vp.address;
        $$("intro").innerHTML = vp.intro;
        $$("intro").oninput();
        $$("behalfPhoto").src = "/ResourceServlet?url=" + vp.behalfPhotoUrl;
        $$("city").dataset.value = vp.city;
        $$("town").dataset.value = vp.town;
        $$("speaker_list").value = vp.speaker.id;


        $$("themeSelect0").innerHTML = '<option value="' + vp.theme[0].id + '">' + vp.theme[0].name + '</option>';
        $$("themeSelect0").dataset.value = vp.theme[0].id;
        bindRegionSelect(0);


        for(var i = 1; i < vp.theme.length; i++) {
            var dom = document.createElement("div");
            dom.className = "form-group";
            dom.innerHTML = '<label style=" margin-top: 25px;">主題地區</label><span id="delRegion' + regionNum +'" onclick="remvoeOneRegion(this)" style="margin-left: 30px; color: orange; cursor: pointer; display: none">刪除這個主題</span>' +
                    '<select id="regionSelect'+ i +'" type="text" name="regionId" class="form-control">' +
                    '<option selected disabled hidden style="display: none" value="">切換以選擇其他景點主題</option>' +
                    '</select>' +
                    '<label>景點主題</label>' +
                    '<select id="themeSelect'+ i +'" name="themeId" class="village fl form-control">' +
                    '<option value="' + vp.theme[i].id + '">' + vp.theme[i].name + '</option>' +
                    '</select>';
            $$("regionGroup").appendChild(dom);

            for (var j = 0; j < regions.length; j++) {
                var dom = '<option value="' + regions[j].id + '">' + regions[j].name + '</option>';
                $$("regionSelect" + i).innerHTML = $$("regionSelect" + i).innerHTML + dom;
            }
            $$("regionSelect" + i).dataset.value = "";

            bindRegionSelect(i);
            regionNum = i + 1;
        }
        if(regionNum > 2) $$("delRegion" + (regionNum-1)).style.display = "inline";


        $$("editAudio").href = "/editAudio.html?id=" + vp.audio.id;
        $$("preview").href = "/viewpoint.html?id=" + vp.id;

        $('#twzipcode').twzipcode();


        map.setCenter({'lat': vp.latitude, 'lng': vp.longitude});
        addMarker({'lat': vp.latitude, 'lng': vp.longitude});
        $$("lat").value = vp.latitude;
        $$("lng").value = vp.longitude;
        if(vp.latLngPri == 1){$$("latLngPri").checked = "checked";}
    }

    //獲取所有的地區，以取得地區下所有的主題
    $.ajax({
        url: "/RegionServlet", context: document.body,
        type: "POST",
        data: {"method": "getAllRegions"},
        success: function (data) {
            regions = eval("(" + data + ")");
            console.dir(data);
            for (var i = 0; i < regions.length; i++) {
                var dom = '<option value="' + regions[i].id + '">' + regions[i].name + '</option>';
                $$("regionSelect0").innerHTML = $$("regionSelect0").innerHTML + dom;
            }
            $$("regionSelect0").dataset.value = "";
        },
    });



    //綁定對應編號的地區下拉選單事件
    function bindRegionSelect(num) {
        var regionSelect = $$('regionSelect' + num);
        var themeSelect = $$('themeSelect' + num);
        //綁定變化事件
        regionSelect.addEventListener("change", function () {
            //獲取主題清單
            $.ajax({
                url: "/ThemeServlet", context: document.body,
                type: "POST",
                data: {"method": "getThemesByRegionId", "regionId": regionSelect.value},
                success: function (data) {
                    var themes = eval("(" + data + ")");
                    console.dir(themes);
                    themeSelect.innerHTML = "";
                    for (var i = 0; i < themes.length; i++) {
                        var dom = '<option value="' + themes[i].id + '">' + themes[i].name + '</option>';
                        themeSelect.innerHTML = themeSelect.innerHTML + dom;
                    }
                }
            });
        });
    }

    //增加景點區塊
    function addRegion() {
        //景點下拉選單HTML
        var GroupDiv = document.createElement("div");
        GroupDiv.className = "form-group";
        GroupDiv.style.marginTop = "20px";
        GroupDiv.innerHTML = ' <label style=" margin-top: 25px;">主題地區</label><span id="delRegion' + regionNum +'" onclick="remvoeOneRegion(this)" style="margin-left: 30px; color: orange; cursor: pointer;">刪除這個主題</span> <select id="regionSelect' + regionNum +'" type="text" name="regionId" class="form-control"></select> <label>景點主題</label> <select id="themeSelect' + regionNum + '" name="themeId" class="village fl form-control"> </select> ';
        $$("regionGroup").appendChild(GroupDiv);

        //填充地區數據
        for (var i = 0; i < regions.length; i++) {
            var dom = '<option value="' + regions[i].id + '">' + regions[i].name + '</option>';
            $$("regionSelect" + regionNum).innerHTML = $$("regionSelect" + regionNum).innerHTML + dom;
        }

        //綁定下拉選單變化事件
        bindRegionSelect(regionNum);
        //觸發事件
        var event = new Event('change');
        $$("regionSelect" + regionNum).dispatchEvent(event);

        //隱藏上方地區下拉選單的刪除按鈕
        if(regionNum > 1) {
            $$("delRegion" + (regionNum - 1)).style.display = "none";
        }
        regionNum++;
    }

    //刪除按下的地區
    function remvoeOneRegion(btn) {
        //刪除自己
        btn.parentNode.parentNode.removeChild(btn.parentNode);
        //顯示上一個地區下拉選單的刪除按鈕
        if(regionNum > 2){
            $$("delRegion" + (regionNum-2)).style.display = "inline";
        }
        regionNum--;
    }


    //當焦點移開地址欄
    $$("address").onblur = function(){
        var url = "http://maps.googleapis.com/maps/api/geocode/json?sensor=false&address=" + $$("address").value;
        //向Google查詢經緯度
        $.ajax({
            url: url, context: document.body,
            type: "POST",
            success: function (data) {
                //如果獲取經緯度失敗，則0.5秒後再次查詢
                if(data.status != "OK"){ setTimeout(function(){$$("address").onblur();}, 500); }
                //如果有正確查到經緯度
                if(data.results[0] != undefined) {
                    var loc = data.results[0].geometry.location;
                    //設定地圖中心點
                    map.setCenter(loc);
                    //設定地圖標記
                    deleteMarkers();
                    var marker = new google.maps.Marker({
                        position: loc,
                        map: map
                    });
                    markers.push(marker);
                    //設定經緯度欄位
                    if (loc.lat != 0 || loc.lng != 0) {
                        $$("lat").value = loc.lat;
                        $$("lng").value = loc.lng;
                    }
                }
            },
        });
    }

    //檢查表單內容後上傳
    function checkForm() {
        //檢查景點名稱
        if($$("name").value == ''){ alert("未填寫景點名稱"); return;}
        //檢查景點副標題
        if($('input[name="subtitle"]').get(0).value == ''){alert("未填寫景點副標題"); return;}

        //檢查音檔檔案格式
        var audioFormat = /\.(aac|mp3|m4a|wav|3gp|3gpp)$/i;  //允許的音檔檔案格式
        var audio = $('input[name="file"]').get(0);
        if(audio.value != '' && audioFormat.test(audio.value) != true){
            alert("景點音檔格式不正確");
            return;
        }
        //檢查景點代表圖格式
        var imgFormat = /\.(jpg|jpeg|raw|gif|png|bmp)$/i;  //允許的音檔檔案格式
        var img = $('input[name="file1"]').get(0);
        if(img.value != '' && imgFormat.test(img.value) != true) {
            alert("景點代表圖格式不正確");
            return;
        }
        $$("mainForm").submit();
    }


    //根據不同的登入者，顯示不同的連結
    $.ajax({
        url: "/SpeakerServlet", context: document.body,
        type: "POST",
        data: {"method": "getLoginUser"},
        success: function (data) {
            var speaker = eval("(" + data + ")");
            console.dir(speaker);

            if(speaker == null) {
                $$("links").innerHTML = '<div style="margin-top: 50px;">尚未登入帳號，請先進行登入</div><div><a href="/login.html">登入</a></div>';
            } else if(speaker.role == 'admin') {
                var dom =
                        '<div class="clearfix">' +
                        '<div class="fl">登入者：' + speaker.username + '</div>' +
                        '<div class="fl"><a href="/LogoutServlet">登出</a></div>' +
                        '</div>' +
                        '<div class="fl"><a href="/manageViewpoints.html">景點管理</a></div>' +
                        '<div class="fl"><a href="/addViewpoint.html">新增景點</a></div>' +
                        '<div class="fl"><a href="/manageSpeakers.html">講者管理</a></div>' +
                        '<div class="fl"><a href="/addSpeaker.html">新增講者</a></div>' +
                        '<div class="fl"><a href="/manageThemes.html">主題管理</a></div>' +
                        '<div class="fl"><a href="/manageRegions.html">地區管理</a></div>' +
                        '<div class="fl"><a href="/manageSNs.html">序號管理</a></div>' +
                        '<div class="fl"><a href="/manageAds.html">廣告管理</a></div>';
                $$("links").innerHTML = dom;
            } else {
                var dom =
                        '<div class="clearfix">' +
                        '<div class="fl">登入者：' + speaker.username + '</div>' +
                        '<div class="fl"><a href="/LogoutServlet">登出</a></div>' +
                        '</div>' +
                        '<div class="fl"><a href="/manageViewpoints.html">景點管理</a></div>' +
                        '<div class="fl"><a href="/addViewpoint.html">新增景點</a></div>' +
                        '<div class="fl"><a href="/manageSpeakers.html">講者管理</a></div>' +
                        '<div class="fl"><a href="/addSpeaker.html">新增講者</a></div>';
                $$("links").innerHTML = dom;
            }
        },
    });

    var map;
    var markers = [];
    function initMap() {
        var initLocation = {lat: 22.925489, lng: 121.125867515};

        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 19,
            center: initLocation,
        });
        map.addListener('click', function(event) {addMarker(event.latLng);});
    }

    function addMarker(location) {
        deleteMarkers();

        var marker = new google.maps.Marker({
            position: location,
            map: map
        });
        markers.push(marker);
        var loc =  location.toString().substring(1, location.toString().length-1);
        $$("lat").value = loc.split(",")[0];
        $$("lng").value = loc.split(",")[1];
    }

    function deleteMarkers() {
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(null);
        }
        markers = [];
    }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCtkHtxJhAxfxCzkdphlPoDoSuCq4FTh_c&callback=initMap"></script>

