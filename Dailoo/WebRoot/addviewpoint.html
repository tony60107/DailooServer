<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>新增景點</title>
    <!-- 最新編譯和最佳化的 CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <!-- 選擇性佈景主題 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- 最新編譯和最佳化的 JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/addviewpoint.css">
</head>
<body>
<div class="w">
    <div class="title" style="margin-top: 20px; text-align: center; font-size: 35px; line-height: 35px;">新增景點</div>
    <div id="links" style="margin-top: 30px; margin-bottom: 30px;"></div>

    <form class="main-form" role="form" action="/ViewpointServlet?method=addViewpoint" method="post"
          enctype="multipart/form-data">
        <div class="area form-group clearfix">
            <input type="text" name="country" class="fl form-control" value="台灣" style="display: none">
            <input type="text" name="village" class="fl form-control" value="" style="display: none">
            <div id="twzipcode" style="width: 500px;">
                <div id="city" data-role="county" data-name="city" data-style="form-control area" data-value="臺東縣"
                     class="fl"></div>
                <div id="town" data-role="district" data-name="town" data-style="form-control area" data-value="鹿野鄉"
                     class="fl"></div>
                <div data-role="zipcode" data-name="zipcode" data-value="" data-style="form-control area"
                     style="display: none"></div>
            </div>
        </div>
        <div class="form-group">
            <label>主題地區</label>
            <select id="regionSelect" type="text" name="regionId" class="form-control"></select>
            <label>景點主題</label>
            <select id="theme" name="themeId" class="village fl form-control">
            </select>
        </div>
        <div class="form-group" style="display: none">
            <label>景點ID</label>
            <input id="viewpointId" type="text" name="id" class="form-control" placeholder="輸入景點ID" value="">
        </div>
        <div class="form-group">
            <label>景點名稱</label>
            <input id="name" type="text" name="name" class="form-control" placeholder="輸入景點名稱" value="">
        </div>

        <div id="audioGroup" class="audio-group">
            <div class="plus" onclick="addAduio();"><img src="images/general/add.png" alt=""></div>
            <div class="form-group audio" style="width: 300px; margin-top: 40px;">
                <label>副標題</label>
                <input type="text" name="subtitle" class="form-control" placeholder="輸入副標題" value="">
                <label>景點音檔</label>
                <input type="file" name="file0" class="form-control">
            </div>

        </div>
        <div class="form-group">
            <label>講者</label>
            <select id="speaker_list" name="speakerId" class="fl form-control"></select>
        </div>

        <div class="form-group">
            <label>景點地址</label>
            <input id="address" type="text" name="address" class="form-control" placeholder="輸入景點地址" value="">
        </div>
        <div class="form-group fl" style="width: 280px; margin-right: 30px;">
            <label>緯度(可不填，由系統自動建立)</label>
            <input id="lat" type="text" name="latitude" class="form-control" placeholder="輸入緯度" value="">
        </div>
        <div class="form-group fl" style="width: 280px;">
            <label>經度(可不填，由系統自動建立)</label>
            <input id="lng" type="text" name="longitude" class="form-control" placeholder="輸入經度" value="">
        </div>
        <div class="form-group fl">
            <label>經緯度優先</label>
            <input id="latLngPri" type="checkbox" name="latLngPri" class="form-control" value="1">
        </div>
        <div id="map" style="width: 600px; height: 300px;"></div>
        <div class="form-group">
            <label>景點介紹</label>
            <textarea id="intro" type="text" name="intro" class="form-control" cols="5" rows="7" wrap="hard" placeholder="輸入景點介紹" style="width: 326px;"></textarea>
        </div>
        <div class="form-group">
            <label>景點代表圖</label>
            <input type="file" name="file1" class="form-control">
        </div>
        <input type="button" class="btn btn-default" value="新增"
               onClick="this.form.action='/ViewpointServlet?method=addViewpoint';this.form.submit();">
    </form>

</div>
</body>
</html>
<script type="text/javascript" src="js/base.js"></script>
<script type="text/javascript" src="js/jquery.twzipcode.min.js"></script>
<script>

    //取得現在所有的講者
    $.ajax({
        url: "/SpeakerServlet", context: document.body,
        type: "POST",
        data: {
            "method": "findAllSpeakers"
        },
        success: function (speakers) {
            var speakers = eval("(" + speakers + ")");
            console.dir(speakers);
            var speakerList = document.getElementById("speaker_list");
            for (var i = 0; i < speakers.length; i++) {
                var dom = '<option value="' + speakers[i].id + '">' + (speakers[i].name == '' ? '未設定該講者姓名' : speakers[i].name) + '</option>';
                speakerList.innerHTML = speakerList.innerHTML + dom;
            }
        },
    });
    $('#twzipcode').twzipcode();

    //增加上傳語音欄位
    function addAduio(){
        var audioGroup = $$("audioGroup");
        //var dom = '<div class="form-group audio" style="width: 300px;"> <div class="del" onclick="delAudio(this);"><img src="images/general/delete.png" alt=""></div> <label>副標題</label> <input type="text" name="subtitle" class="form-control" placeholder="輸入副標題" value=""> <label>景點音檔</label> <input type="file" name="file0" class="form-control"> </div>';
        var formDiv = document.createElement("div");
        formDiv.className = "form-group audio";
        formDiv.style = "width: 300px;";
        var delBtn = document.createElement("div");
        delBtn.className = "del";
        delBtn.onclick = function(){delAudio(this);};
        var delBtnImg = document.createElement("img");
        delBtnImg.src = "images/general/delete.png";
        delBtn.appendChild(delBtnImg);
        formDiv.appendChild(delBtn);
        var subtitleLabel = document.createElement("label");
        subtitleLabel.innerHTML = "副標題";
        formDiv.appendChild(subtitleLabel);
        var subtitleInput = document.createElement("input");
        subtitleInput.type = "text";
        subtitleInput.name = "subtitle";
        subtitleInput.className = "form-control";
        subtitleInput.placeholder = "輸入副標題";
        formDiv.appendChild(subtitleInput);
        var audioLabel = document.createElement("label");
        audioLabel.innerHTML = "景點音檔";
        formDiv.appendChild(audioLabel);
        var audioInput = document.createElement("input");
        audioInput.type = "file";
        audioInput.name="file";
        audioInput.className = "form-control";
        formDiv.appendChild(audioInput);
        audioGroup.appendChild(formDiv);
        //audioGroup.innerHTML = audioGroup.innerHTML + dom;
    }

    //刪除上傳語音欄位
    function delAudio(btn){
        btn.parentNode.parentNode.removeChild(btn.parentNode);
    }

    //獲取所有的地區，以取得地區下所有的主題
    $.ajax({
        url: "/RegionServlet", context: document.body,
        type: "POST",
        data: {"method": "getAllRegions"},
        success: function (data) {
            var regions = eval("(" + data + ")");
            console.dir(data);
            for(var i = 0; i < regions.length; i++){
                var dom = '<option value="'+ regions[i].id +'">' + regions[i].name +'</option>';
                $$("regionSelect").innerHTML = $$("regionSelect").innerHTML + dom;
            }
            $$("regionSelect").onchange();
        },
    });

    //當主題地區變更時，抓取該地區下的所有主題
    $$("regionSelect").onchange = function() {
        $.ajax({
            url: "/ThemeServlet", context: document.body,
            type: "POST",
            data: {"method": "getThemesByRegionId", "regionId": $$("regionSelect").value},
            success: function (data) {
                var themes = eval("(" + data + ")");
                console.dir(data);
                $$("theme").innerHTML = "";
                for (var i = 0; i < themes.length; i++) {
                    var dom = '<option value="' + themes[i].id + '">' + themes[i].name + '</option>';
                    $$("theme").innerHTML = $$("theme").innerHTML + dom;
                }
            }
        });
    }

    $$("address").onblur = function(){
        var url = "http://maps.googleapis.com/maps/api/geocode/json?sensor=false&address=" + $$("address").value;

        $.ajax({
            url: url, context: document.body,
            type: "POST",
            success: function (data) {
                if(data.status != "OK"){  $$("address").onblur();}
                var loc = data.results[0].geometry.location;
                map.setCenter(loc);
            },
        });
    }

    //根據不同的登入者，顯示不同的連結
    $.ajax({
        url: "/SpeakerServlet", context: document.body,
        type: "POST",
        data: {"method": "getLoginUser"},
        success: function (data) {
            var speaker = eval("(" + data + ")");
            console.dir(speaker);

            if(speaker == null) {
                $$("links").innerHTML = '<div>尚未登入帳號，請先進行登入</div><div><a href="/login.html">登入</a></div>';
                $$("filter").innerHTML = "";
            } else if(speaker.role == 'admin') {
                var dom =
                        '<div><a href="/addViewpoint.html">新增景點</a></div>' +
                        '<div><a href="/manageRegions.html">地區管理頁面</a></div>' +
                        '<div><a href="/manageThemes.html">主題管理頁面</a></div>' +
                        '<div><a href="/manageViewpoints.html">景點管理頁面</a></div>' +
                        '<div><a href="/manageSpeakers.html">講者管理頁面</a></div>' +
                        '<div><a href="/manageSNs.html">序號管理頁面</a></div>' +
                        '<div>登入者： ' + speaker.username + '</div>' +
                        '<div><a href="/LogoutServlet">登出</a></div>';

                $$("links").innerHTML = dom;
            } else {
                var dom =
                        '<div><a href="/addViewpoint.html">新增景點</a></div>' +
                        '<div><a href="/manageViewpoints.html">景點管理頁面</a></div>' +
                        '<div><a href="/manageSpeakers.html">講者管理頁面</a></div>' +
                        '<div><a href="/manageSNs.html">序號管理頁面</a></div>' +
                        '<div>登入帳號： ' + speaker.username + '</div>' +
                        '<div><a href="/LogoutServlet">登出</a></div>';
                $$("links").innerHTML = dom;
            }
        },
    });


    var map;
    var markers = [];
    function initMap() {
        var initLocation = {lat: 22.925489, lng: 121.125867515};

        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 19,
            center: initLocation,
        });
        map.addListener('click', function(event) {addMarker(event.latLng);});
    }

    function addMarker(location) {
        deleteMarkers();

        var marker = new google.maps.Marker({
            position: location,
            map: map
        });
        markers.push(marker);
        var loc =  location.toString().substring(1, location.toString().length-1);
        $$("lat").value = loc.split(",")[0];
        $$("lng").value = loc.split(",")[1];
    }

    function deleteMarkers() {
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(null);
        }
        markers = [];
    }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCtkHtxJhAxfxCzkdphlPoDoSuCq4FTh_c&callback=initMap"></script>