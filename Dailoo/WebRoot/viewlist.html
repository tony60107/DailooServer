<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="user-scalable=no"/>
    <title>鹿野帶路語音導覽  選擇主題</title>
    <meta name="Keywords" content="Dailoo, 帶路, 鹿野, 語音導覽, 導覽, 導遊, 高台散步, 鹿野品茶, 龍田逛逛">
    <meta name="Description" content="鹿野週邊語音導覽服務 - 就像導遊親自為您解說">
    <link rel="shortcut icon" href="images/general/dailoo.png">
    <link rel="stylesheet" href="css/base.css"/>
    <link rel="stylesheet" href="css/viewlist.css"/>
    <style>

    </style>
</head>
<body>
<div class="w">
    <div class="nav clearfix">
        <a id="backward" href="themelist.html">
            <img class="back fl" src="images/viewlist/back.png"/>
        </a>
        <div id="title" class="title" onclick="switchDrop();"><span id="drop" class="drop"></span></div>
    </div>

    <div id="themelist" class="themelist">
        <!--div class="reply" onclick="$$('drop').style.display = 'inline-block'; themelist.style.display = 'none';"><img src="images/viewlist/reply.png"/></div-->
    </div>

    <div id="viewlist" class="viewlist clearfix">
    </div>

</div>
<iframe class="footer" src="footer.html" id="footerIframe" width="100%" height="0" marginwidth="0" marginheight="0"
        scrolling="No" frameborder="0" style="margin-top: 80px;"></iframe>
</body>

</html>

<script type="text/javascript" src="js/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="js/base.js"></script>
<script language="javascript">

    //獲取主題ID
    var themeId = location.href.split("id=")[1];
    //如果沒有主題ID，則跳轉到鹿野地區主題列表
    if(typeof themeId == 'undefined'){location.href = "/themelist.html?id=e3cfc0f0-a9f5-439b-a534-efff46ced2ce"}

    var themelist = $$("themelist");
    var title = $$("title");

    //依據主題ID，從伺服器中獲取該主題下的景點
    getViewpointsDataFromServer(themeId);

    //獲取主題列表並新增到導航欄中
    $.ajax({
        url: "/ThemeServlet", context: document.body,
        type: "POST",
        data: {"method": "getThemesByThemeId", "id": themeId},
        success: function (data) {
            var themes = eval("(" + data + ")");
            console.dir(themes);
            for(var i = 0; i < themes.length; i++){
                var dom = '<div class="theme" onclick="getViewpointsDataFromServer(\''+ themes[i].id +'\',\'' + themes[i].name.split(",")[0] + '\', this);">' + themes[i].name.split(",")[0] + '</div>';
                themelist.innerHTML = themelist.innerHTML + dom;
                if(themes[i].id == themeId) {
                    title.innerHTML = themes[i].name.split(",")[0] + '<span id="drop" class="drop"></span>';
                    $$("backward").href = "/themelist.html?id=" + themes[i].regionId;
                }
            }
            //增加返回按鈕
            themelist.innerHTML = themelist.innerHTML +  '<div class="reply" onclick="$$(\'drop\').style.display = \'inline-block\'; themelist.style.display = \'none\';"><img src="images/viewlist/reply.png"/></div>';
        },
    });

    history.replaceState(null, null, location.href);

    //依據主題ID，從伺服器中獲取該主題下的景點
    function getViewpointsDataFromServer(themeId, themeName, btn) {

        //更換標題文字
        if(themeName != null) title.innerHTML = themeName + '<span id="drop" class="drop"></span>';
        $.ajax({
            url: "/ViewpointServlet", context: btn,
            type: "POST",
            data: {"method": "getViewpointSimplesByThemeIdAndPublish", "themeId": themeId},
            success: function (data) {
                var vps = eval("(" + data + ")");
                console.dir(vps);
                initDataFromServer(vps);
            },
        });
    }

    //將該主題的景點資料，新增到景點列表中
    function initDataFromServer(vps){
        themelist.style.display = "none";
        $$("viewlist").innerHTML = "";
        for(var i = 0; i < vps.length; i++) {
            var dom = '<a class="view" href="viewpoint.html?utm_source=InSite&utm_campaign='+ vps[i].name + '_' + vps[i].subtitle + '&id=' + vps[i].id +'">' +
                '<img src="/ResourceServlet?url=' + vps[i].behalfPhotoUrl + '">' +
                '<div class="cover"></div>' +
                '<div class="title">' + vps[i].name + '</div>' +
                '<img class="speaker-photo fl" src="/ResourceServlet?url='+ vps[i].speakerPhotoUrl +'" alt="">' +
                '<div class="fl">' +
                    '<div class="speaker">' + vps[i].speakerName + '</div>' +
                    '<div class="time">' + parseInt(vps[i].audioLength / 60) + '分' + vps[i].audioLength % 60 + '秒</div>' +
                '</div>' +
                '</a>';

            $$("viewlist").innerHTML = $$("viewlist").innerHTML + dom;
        }
    }

    function switchDrop(){
        var drop = $$('drop');
        if(themelist.style.display == 'none') { //如果主題下拉選單未顯示
            //顯示下拉選單
            drop.style.display = 'none';
            themelist.style.display = 'block';

            //設定當前選中主題
            var themes = $(".theme");
            for(var i = 0; i < themes.length; i++) {
                themes[i].className = "theme";
                if(themes[i].innerText == title.innerText){
                    themes[i].className = "theme select";
                }
            }
        } else {
            drop.style.display = 'inline-block';
            themelist.style.display = 'none';
        }
    }


    window.onload = function() {
        //更換Footer樣式
        var jinfeng = "03326ff3-cad4-42bc-a8aa-35fca64eb2ef,8daa252d-42e6-4535-a0b6-d794d7e5029d,e6862f47-a7a3-4b22-9647-763425705f0a,10c09cb8-355c-4db9-a852-fc3d20eca556,9de8cafd-203e-4f5e-8faf-aeda29264952,4652c369-be78-460d-90e3-e0e66267069f";
        if(jinfeng.indexOf(themeId) != -1){ //如果是金峰鄉主題
            $$("footerIframe").contentWindow.changeCss("orange");
        }
    }


</script>